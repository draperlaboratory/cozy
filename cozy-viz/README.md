# cozy-viz

This is a visualization tool for symbolic execution traces generated by cozy.
You can use it to explore the tree of possible behaviors of a binary, before
and after the application of a patch.

## Usage

### Running

To use cozy-viz locally, you'll need to serve the directory contents. `python
-m http.server` will generally do the trick. If you'd like a fancier
development-oriented server, and you have nix installed and flakes enabled, you
can `nix run` to fire up a configured `browser-sync`. If you've installed cozy
with `pip`, you should also be able to launch cozy-viz using the functions in
cozy's `server.py`â€”check [the
documentation](https://draperlaboratory.github.io/cozy/launchingavisualization.html)
for that. A script generated using [cozy's template generation wizard](..#template-wizard) can be
configured to use this mechanism to launch cozy's visualization server.

### Loading Traces

Once you have the application running in your browser, you need a JSON export
of a comparitive symbolic execution. Example traces are available as artifacts
from Cozy's CI builds,
[here](https://github.com/draperlaboratory/cozy/actions/). Drag and drop the
trace into the browser window that where you've opened cozy-viz. After
a moment, you should see two trees, representing the possible execution paths
in the two traces.

### Comparing Branches

To compare two execution paths, you can start by mousing over nodes in the
prepatch tree. A tooltip will let you see information associated with each
node: blocks of assembly, logical constraints on arguments, stdout and stderr
contents, and any error messages associated with failed states (failed states
are highlighted in a light red color), and potentially some other properties.

Once you've found an interesting execution path in the prepatch tree, click on
the terminal node of the path. The right tree will then highlight the branches
that could occur, compatible with the constraints on input required to produce
the first branch you selected. You can explore these compatible branches using
the tooltip, and select one by clicking its terminal node.

#### Comparison Tools

When you select a compatible branch, a number of comparison tools become
available. You should see one or more buttons at the bottom of the screen light
up to indicate their availability. Each of these buttons provides a comparison
tool that you can use to compare the two selected branches. The set of
available comparison tools will depend on exactly what information was packed
into the traces during symbolic execution.[^1]

[^1]: Check out the parameters documented
    [here](https://draperlaboratory.github.io/cozy/autoapi/cozy/execution_graph/index.html#cozy.execution_graph.dump_comparison)
    to get a sense of the options.

The available tools are:

1. Assembly: this performs a git-style diff on the stream of assembly
   instructions executed along the two branches. If DWARF debug data is
   available and enabled in cozy, a mouse hover over a piece of assembly will
   show the corresponding line number in the original source.
2. Memory: this provides a comparison of any possible differences in memory
   contents for the two branches, at the end of execution. These differences
   can be presented symbolically, or in the form of concrete examples of
   possible memory contents.
3. Registers: this is analogous to the Memory panel, but for registers. Both
   concrete and symbolic comparisons are available.
4. Concretions: this tool compares the inputs that produce each of the selected
   pair of compatible branches. If there are inputs that produce one of the
   branches but not the other, you'll see that here, along with some examples.
   You'll also be able to find examples of inputs that produce both of the two
   branches.
5. Actions: this performs a git-style diff on the "actions" performed along
   each of the branches. Actions correspond to `SimActions` recorded in Angr's
   `SimStateHistory`[^2] along the path, but essentially amount to a listing of
   interesting behaviors, including memory and register reads and writes, along
   the branches.
6. Side Effects: this performs a git-style diff on configurable side-effects
   encountered along each of the branches, like "virtual print" directives that
   might print out a bit of program state. Documentation for producing
   side-effects during symbolic execution can be found
   [here](https://draperlaboratory.github.io/cozy/sideeffects.html).

[^2]: https://docs.angr.io/en/latest/api.html#angr.state_plugins.history.SimStateHistory.actions

To compare a different set of branches, click a new terminal node in the left
pane. This will highlight a new set of compatible branches on the right, and
you can select one of those as above.
